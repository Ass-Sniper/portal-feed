# =========================================================
# Portal Gateway main server
# =========================================================

server {
    listen 192.168.16.1:8081;   # 管理 VLAN
    listen 172.16.10.1:8081;    # Guest VLAN

    # auth_request 拒绝时统一重定向到 Portal
    error_page 401 403 = @portal_redirect;

    # =====================================================
    # 1. Android / HarmonyOS 连通性探测
    #    - clients3.google.com
    #    - connectivitycheck.*.huawei.com
    #    期望：HTTP 204
    # =====================================================
    location = /generate_204 {
        auth_request /__portal_auth;

        if ($portal_auth != "allow") {
            return 302 http://$host/;
        }

        add_header Content-Length 0;
        return 204;
    }

    # =====================================================
    # 2. iOS / iPadOS 连通性探测
    #    captive.apple.com/hotspot-detect.html
    #    期望：HTTP 200 + 特定内容
    # =====================================================
    location = /hotspot-detect.html {
        default_type text/html;
        auth_request /__portal_auth;

        if ($portal_auth != "allow") {
            return 302 http://$host/;
        }

        return 200 "Success\n";
    }

    # -----------------------------------------------------
    # Portal 主业务入口（非探测流量）
    # -----------------------------------------------------
    location / {

        # 1. 启用 auth_request（交给 signer 判定）
        auth_request /__portal_auth;

        # 2. 注入 Portal Header（来自 fw/agent）
        include /etc/nginx/conf.d/portal/portal-headers.conf;

        # 3. 反向代理到 Portal Server
        proxy_pass http://portal_server;
    }

    # -----------------------------------------------------
    # 内部 auth_request 子请求（Signer）
    # -----------------------------------------------------
    location = /__portal_auth {
        internal;

        proxy_pass http://portal_signer;

        # 关闭缓存，确保每次请求都到达 signer
        proxy_no_cache 1;
        proxy_cache_bypass 1;
        # 明确告诉 signer：这是 auth_request
        proxy_set_header X-Portal-Auth-Request 1;

        # 客户端上下文（来自 fw 注入）
        proxy_set_header X-Client-IP        $remote_addr;
        proxy_set_header X-Client-MAC       $portal_mac;
        proxy_set_header X-Client-SSID      $portal_ssid;
        proxy_set_header X-Client-Radio-ID  $portal_radio_id;
        proxy_set_header X-Portal-VLAN-ID   $portal_vlan_id;
        proxy_set_header X-Portal-AP-ID     $portal_ap_id;
        proxy_set_header X-Client-OS        $portal_os;

        # auth_request 规范要求
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
    }

    location @portal_redirect {
        return 302 http://$host/?vlan=$portal_vlan_id&ssid=$portal_ssid;
    } 
}