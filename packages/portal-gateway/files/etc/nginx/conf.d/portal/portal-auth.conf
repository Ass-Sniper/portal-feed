# =========================================================
# Portal auth_request result handling
# =========================================================

# ---------------------------------------------------------
# 1. 捕获 auth_request 的 HTTP 返回码
#    （这是 nginx 内建能力）
# ---------------------------------------------------------
auth_request_set $auth_status $upstream_status;

# ---------------------------------------------------------
# 2. 捕获 auth_request（Signer）返回的业务语义 Header
#
# 设计说明：
# - Signer 作为独立的鉴权组件，不仅通过 HTTP 状态码表达结果，
#   还会通过 Header 返回更细粒度的业务状态
#
# Signer 约定返回的 Header：
# - X-Portal-Signature : 计算后的 HMAC / 签名结果
# - X-Portal-Signer   : Signer 内部处理状态（ok / invalid / expired / error）
# - X-Portal-Auth     : 业务鉴权语义（allow / deny）
#
# 本段通过 auth_request_set 将上述 Header 提取为 nginx 变量，
# 供后续模块使用：
# - $portal_hmac      → 注入到上游 Portal Server（见 portal-headers.conf）
# - $signer_status   → 用于日志与可观测性
# - $auth_result     → 业务语义，可与 HTTP 状态码交叉校验
# ---------------------------------------------------------
auth_request_set $portal_hmac    $upstream_http_x_portal_signature;
auth_request_set $signer_status  $upstream_http_x_portal_signer;
auth_request_set $auth_result    $upstream_http_x_portal_auth;

# ---------------------------------------------------------
# 3. 将 HTTP 状态码映射为统一 auth 语义
# ---------------------------------------------------------
map $auth_status $portal_auth {
    default "error";

    200 "allow";
    401 "deny";
    403 "deny";

    500 "error";
    502 "error";
    504 "timeout";
}