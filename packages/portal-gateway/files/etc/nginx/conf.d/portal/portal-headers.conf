#
# portal-headers.conf
#
# Trusted Header Injection for Captive Portal
#
# 设计目标：
# - 在 Nginx 层统一构建“可信请求上下文”
# - 防止客户端伪造任何 Portal / 鉴权相关 Header
# - 明确 Header 的责任边界：fw → nginx → signer → portal
#

# --------------------------------------------------------------------
# 1. 清理客户端可能伪造的 Header
#
# 说明：
# - 所有 X-Portal-* Header 均被视为“可信控制面字段”
# - 在进入 Portal Gateway 前，必须无条件清空
# - 防止客户端通过直接构造 HTTP Header 绕过鉴权逻辑
# --------------------------------------------------------------------

proxy_set_header X-Portal-MAC        "";
proxy_set_header X-Portal-IP         "";
proxy_set_header X-Portal-SSID       "";
proxy_set_header X-Portal-AP-ID      "";
proxy_set_header X-Portal-Radio-ID   "";
proxy_set_header X-Portal-Timestamp  "";
proxy_set_header X-Portal-Nonce      "";
proxy_set_header X-Portal-Signature  "";

# --------------------------------------------------------------------
# 2. 注入基础可信 Header（与客户端输入无关）
#
# 说明：
# - 以下字段由 Nginx 自身或内核网络栈提供
# - 不依赖客户端请求内容，属于强可信来源
# --------------------------------------------------------------------

# 客户端 IP（来自 L3 层，由内核提供）
proxy_set_header X-Portal-IP $remote_addr;

# 请求时间戳（秒级 UNIX 时间）
# 用于防重放、防过期校验
proxy_set_header X-Portal-Timestamp $time_epoch;

# 请求级唯一标识（Nginx 内建 request_id）
# 用作 Nonce，保证同一请求在签名层的唯一性
proxy_set_header X-Portal-Nonce $request_id;

# --------------------------------------------------------------------
# 3. AP / 无线上下文（来自数据面 fw / agent）
#
# 说明：
# - MAC / SSID / AP-ID / Radio-ID 并非由客户端提供
# - 而是由 portal-fw.sh / agent 在数据面注入
# - Nginx 仅负责接收、清洗并可信转发
#
# 统一使用 X-Portal-* 命名空间，避免语义混乱
# --------------------------------------------------------------------

proxy_set_header X-Portal-MAC        $http_x_portal_mac;
proxy_set_header X-Portal-SSID       $http_x_portal_ssid;
proxy_set_header X-Portal-AP-ID      $http_x_portal_ap_id;
proxy_set_header X-Portal-Radio-ID   $http_x_portal_radio_id;

# --------------------------------------------------------------------
# 4. HMAC / 签名字段（由 auth_request + signer 填充）
#
# 说明：
# - 该字段不是在主请求阶段计算
# - 而是在 auth_request 子请求中由 signer 返回
# - Nginx 在此处仅负责“透传签名结果”
#
# 相关变量：
# - $portal_hmac  ← 来自 portal-auth.conf 中的 auth_request_set
# --------------------------------------------------------------------

proxy_set_header X-Portal-Signature  $portal_hmac;