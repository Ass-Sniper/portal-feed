#
# portal-headers.conf
#
# Trusted Header Injection for Captive Portal
#
# 设计目标：
# - 在 Nginx 层统一构建“可信请求上下文（Trusted Request Context）”
# - 防止客户端伪造任何 Portal / Access / 鉴权相关 Header
# - 明确 Header 的责任边界：data-plane → nginx → signer → portal
# - 为后续 AC / Policy / Zero-Trust 演进预留结构
#

# ====================================================================
# 1. 清理客户端可能伪造的 Header（Trust Boundary）
# --------------------------------------------------------------------
# 说明：
# - 所有 X-Portal-* / X-Access-* / X-Client-* Header
#   均不得直接信任客户端输入
# - 在进入 Portal Gateway 前，必须显式清空
# - 防止客户端通过 curl / app / JS 构造 Header 绕过鉴权
#
# 原则：
# - Header 只能由「受控组件」注入
# - Client → 永远不被信任
# ====================================================================

proxy_set_header X-Client-IP         "";
proxy_set_header X-Client-MAC        "";
proxy_set_header X-Client-SSID       "";
proxy_set_header X-Client-Radio-ID   "";
proxy_set_header X-Client-OS         "";

proxy_set_header X-Portal-IP         "";
proxy_set_header X-Portal-VLAN-ID    "";
proxy_set_header X-Portal-AP-ID      "";

proxy_set_header X-Portal-Timestamp  "";
proxy_set_header X-Portal-Nonce      "";
proxy_set_header X-Portal-Signature  "";

# ====================================================================
# 2. 注入基础强可信 Header（Nginx / Kernel 来源）
# --------------------------------------------------------------------
# 说明：
# - 以下字段不依赖客户端输入
# - 由内核网络栈或 Nginx 自身生成
# - 属于系统级“强可信”字段
# ====================================================================

# Client IP（来自 TCP 连接对端）
# 注意：
# - 这是 L3/L4 层身份
# - 语义上是 HTTP Client IP，而非“设备固有属性”
proxy_set_header X-Client-IP $remote_addr;

# Portal 视角下看到的 Client IP
# 保留 X-Portal-IP 是为了区分：
# - 原始 Client IP
# - 未来可能存在的 NAT / Proxy / Tunnel IP
proxy_set_header X-Portal-IP $remote_addr;

# 请求时间戳（Unix epoch，秒.毫秒）
# 用于：
# - 防重放攻击
# - 请求过期校验
proxy_set_header X-Portal-Timestamp $msec;

# 请求级唯一 ID（Nginx 内建 request_id）
# 作为 Nonce 使用，保证每个请求唯一
proxy_set_header X-Portal-Nonce $request_id;

# ====================================================================
# 3. Client / Wireless / Access 上下文（来自数据面 fw / agent）
# --------------------------------------------------------------------
# 说明：
# - 以下字段不由 Client 提供
# - 而是由 portal-fw.sh / AP agent / 内核态逻辑注入
# - Nginx 只做：
#     1) 清洗
#     2) 可信转发
#
# 语义划分：
# - X-Client-*  ：终端自身属性（被认证主体）
# - X-Portal-*  ：接入网络 / 执行环境上下文
# ====================================================================

# -------------------------
# Client（终端身份）
# -------------------------

# 终端 MAC 地址（ARP / DHCP / 内核态获得）
# 是 Client 的核心物理身份
proxy_set_header X-Client-MAC       $portal_mac;

# 终端操作系统指纹（iOS / Android / Windows / macOS 等）
# 用于策略、审计、风控
proxy_set_header X-Client-OS        $portal_os;

# -------------------------
# Wireless（无线接入态）
# -------------------------

# Client 当前连接的 SSID
# SSID 是无线逻辑网络，不等同于 VLAN
proxy_set_header X-Client-SSID      $portal_ssid;

# Client 所在 Radio / Band
# 多 Radio / Wi-Fi 6/7 / MLO 场景下非常重要
proxy_set_header X-Client-Radio-ID  $portal_radio_id;

# -------------------------
# Access / Portal（网络施加的上下文）
# -------------------------

# Portal / 网络为 Client 分配的 VLAN
# VLAN 是策略结果，不属于 Client 固有属性
proxy_set_header X-Portal-VLAN-ID   $portal_vlan_id;

# 执行 Portal 的 AP 标识
# 用于定位接入点、策略归属、故障排查
proxy_set_header X-Portal-AP-ID     $portal_ap_id;

# ====================================================================
# 4. HMAC / 签名字段（auth_request + signer 注入）
# --------------------------------------------------------------------
# 说明：
# - 签名不是在主请求阶段生成
# - 而是在 auth_request 子请求中完成
# - signer 对：
#     Client + Access + Timestamp + Nonce
#   做完整性签名
#
# Nginx 角色：
# - 不参与计算
# - 只负责透传可信结果
#
# 相关变量：
# - $portal_hmac ← 来自 portal-auth.conf 中的 auth_request_set
# ====================================================================

proxy_set_header X-Portal-Signature $portal_hmac;