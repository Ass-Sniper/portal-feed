# =========================================================
# nginx.conf for ImmortalWrt Portal Gateway
# =========================================================

user root;
worker_processes 1;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
}

http {
    # ------------------------------------------------------------
    # proxy_headers_hash tuning
    #
    # Portal Gateway / auth_request 场景下会使用大量 proxy_set_header
    # nginx 在构建 proxy header hash 表时可能出现：
    #   "could not build optimal proxy_headers_hash" warning
    # 该 warning 不影响功能，仅表示 hash 表容量偏小，
    # nginx 会自动 fallback 到次优布局。
    #
    # 下面的参数用于消除 warning，并提升 header 查找效率，
    # 对嵌入式设备（OpenWrt / ImmortalWrt）是安全的。
    # ------------------------------------------------------------
    proxy_headers_hash_max_size 1024;
    proxy_headers_hash_bucket_size 128;

    # -----------------------------------------------------
    # 基础设置
    # -----------------------------------------------------
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;

    keepalive_timeout 30s;
    keepalive_requests 100;

    server_tokens off;

    # =========================================================
    # Portal Gateway 日志配置（接入 OpenWrt logread）
    #
    # 说明：
    # - OpenWrt / ImmortalWrt 的 logread 只能读取 syslog（logd）
    # - nginx 默认写文件日志，logread 看不到
    # - 这里改为直接写入 /dev/log（syslog socket）
    #
    # 好处：
    # - nginx / iptables / dnsmasq 日志统一时间线
    # - 方便排查 Portal 重定向、OS 探测、登录失败
    # =========================================================

    # 自定义 Portal 语义日志格式
    #
    # 字段说明：
    # - $remote_addr         ：客户端 IP
    # - $time_local          ：请求时间
    # - $request             ：完整 HTTP 请求行
    # - $portal_os           ：基于 User-Agent 识别的客户端操作系统（ios / windows / android / unknown）
    # - $status              ：HTTP 状态码（302 / 204 / 200 等）
    # - $signer_status       ：signer 返回的签名状态（valid / invalid / missing）
    # - $portal_auth         ：auth_request 结果（allow / deny / error / timeout）
    # - $http_x_client_mac   ：portal-fw.sh 注入的客户端 MAC
    # - $http_x_client_ssid  ：客户端所连 SSID
    # - $http_x_radio_id     ：radio 标识（radio0 / radio1）
    # - $http_user_agent     ：User-Agent（区分 iOS / Windows / Android）
    #
    log_format portal_main
        '$remote_addr [$time_local] '
        '"$request" $status '
        'os="$portal_os" '
        'auth="$portal_auth" '
        'signer="$signer_status" '
        'mac="$http_x_portal_mac" '
        'ssid="$http_x_portal_ssid" '
        'radio="$http_x_portal_radio_id" '
        'ua="$http_user_agent"';

    # ---------------------------------------------------------
    # 文件日志（调试 / 离线分析）
    access_log /var/log/nginx/portal-access.log portal_main;
    error_log  /var/log/nginx/portal-error.log info;
    # ---------------------------------------------------------

    # ---------------------------------------------------------
    # Access log → syslog
    # server=unix:/dev/log
    #   - OpenWrt 的 syslog socket
    # tag=portal_gateway
    #   - logread 中显示的 TAG
    #   - 用于 grep 过滤
    # portal_main
    #   - 上面定义的日志格式
    # ---------------------------------------------------------
    access_log syslog:server=unix:/dev/log,tag=portal_gateway portal_main;

    # ---------------------------------------------------------
    # Error log → syslog
    # 级别说明：
    # - info  ：调试阶段推荐
    # - warn  ：稳定后可调低
    error_log  syslog:server=unix:/dev/log,tag=portal_gateway info;

    # -----------------------------------------------------
    # DNS resolver（用于 proxy_pass 到域名）
    # -----------------------------------------------------
    resolver 127.0.0.1 valid=30s ipv6=off;

    # -----------------------------------------------------
    # 限速 / 防护（基础）
    # -----------------------------------------------------
    limit_conn_zone $binary_remote_addr zone=portal_conn:10m;
    limit_req_zone  $binary_remote_addr zone=portal_req:10m rate=10r/s;

    # -----------------------------------------------------
    # include Portal Gateway 子配置
    # -----------------------------------------------------
    include /etc/nginx/conf.d/portal/*.conf;
}