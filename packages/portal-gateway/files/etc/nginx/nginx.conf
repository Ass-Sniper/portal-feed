# =========================================================
# nginx.conf for ImmortalWrt Portal Gateway
# =========================================================

user root;
worker_processes 1;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
}

http {
    # ------------------------------------------------------------
    # proxy_headers_hash tuning
    #
    # Portal Gateway / auth_request 场景下会使用大量 proxy_set_header
    # nginx 在构建 proxy header hash 表时可能出现：
    #   "could not build optimal proxy_headers_hash" warning
    # 该 warning 不影响功能，仅表示 hash 表容量偏小，
    # nginx 会自动 fallback 到次优布局。
    #
    # 下面的参数用于消除 warning，并提升 header 查找效率，
    # 对嵌入式设备（OpenWrt / ImmortalWrt）是安全的。
    # ------------------------------------------------------------
    proxy_headers_hash_max_size 1024;
    proxy_headers_hash_bucket_size 128;

    # -----------------------------------------------------
    # 基础设置
    # -----------------------------------------------------
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;

    keepalive_timeout 30s;
    keepalive_requests 100;

    server_tokens off;

    # =========================================================
    # Portal Gateway 日志配置（接入 OpenWrt logread）
    #
    # 说明：
    # - OpenWrt / ImmortalWrt 的 logread 只能读取 syslog（logd）
    # - nginx 默认写文件日志，logread 看不到
    # - 这里改为直接写入 /dev/log（syslog socket）
    #
    # 好处：
    # - nginx / iptables / dnsmasq 日志统一时间线
    # - 方便排查 Portal 重定向、OS 探测、登录失败
    # =========================================================

    # =========================================================
    # Portal Gateway - Custom Semantic Access Log
    #
    # 设计目标：
    # - 面向 Captive Portal 场景的“业务级”日志，而非普通 HTTP 访问日志
    # - 支持多 AP / 多 VLAN / 多 Radio / 多终端操作系统
    # - 可直接用于排障、审计、统计与集中日志系统（ELK / Loki）
    #
    # ---------------------------------------------------------
    # 字段说明：
    #
    # 基础请求信息
    # - $remote_addr        : 客户端 IP 地址（来自内核 / br-lan / VLAN 接口）
    # - $time_local         : 本地时间（便于与系统 / firewall / signer 日志对齐）
    # - $request            : 完整 HTTP 请求行（方法 + URI + 协议）
    # - $request_uri        : 原始请求 URI（用于区分探测请求与业务请求）
    # - $status             : 最终对客户端返回的 HTTP 状态码
    #                          - 204 : Android / HarmonyOS 探测放行
    #                          - 200 : iOS / iPadOS 探测放行
    #                          - 302 : 未认证重定向至 Portal
    #
    # Portal 识别与鉴权语义
    # - $portal_os          : 基于 User-Agent / Host 规则识别的客户端操作系统
    #                          - ios / android / windows / harmonyos / unknown
    # - $portal_auth        : Portal 鉴权语义结果（来自 auth_request 映射）
    #                          - allow / deny / error / timeout
    # - $auth_status        : auth_request 子请求的 HTTP 返回码
    #                          - 用于与 $portal_auth 进行交叉验证
    # - $signer_status      : Signer 返回的业务状态
    #                          - ok / invalid / expired / error
    #
    # 多 AP / 多 VLAN / 多 Radio 上下文
    # - $portal_ap_id       : AP 唯一标识（支持多 AP 集群部署）
    # - $portal_vlan_id     : 客户端所属 VLAN ID（多 SSID / 多业务隔离关键字段）
    # - $http_x_portal_mac  : 客户端 MAC 地址（由 portal-fw.sh 注入）
    # - $http_x_portal_ssid : 客户端所连接的 SSID
    # - $http_x_portal_radio_id
    #                       : 无线射频标识（如 radio0 / radio1 / ra0 / rax0）
    #
    # 客户端特征
    # - $http_user_agent    : User-Agent 字符串（用于精细化 OS / 终端识别）
    #
    # ---------------------------------------------------------
    # 日志格式特点：
    # - 采用 key="value" 形式，天然兼容 ELK / Loki / grep
    # - 单行完整表达一次 Portal 判定的“因果链”
    # =========================================================

    log_format portal_main
        '$remote_addr [$time_local] '
        '"$request" $status '
        'uri="$request_uri" '
        'os="$portal_os" '
        'auth="$portal_auth" '
        'auth_status="$auth_status" '
        'signer="$signer_status" '
        'ap="$portal_ap_id" '
        'vlan="$portal_vlan_id" '
        'mac="$http_x_portal_mac" '
        'ssid="$http_x_portal_ssid" '
        'radio="$http_x_portal_radio_id" '
        'ua="$http_user_agent"';

    # ---------------------------------------------------------
    # 文件日志（调试 / 离线分析）
    access_log /var/log/nginx/portal-access.log portal_main;
    error_log  /var/log/nginx/portal-error.log info;
    # ---------------------------------------------------------

    # ---------------------------------------------------------
    # Access log → syslog
    # server=unix:/dev/log
    #   - OpenWrt 的 syslog socket
    # tag=portal_gateway
    #   - logread 中显示的 TAG
    #   - 用于 grep 过滤
    # portal_main
    #   - 上面定义的日志格式
    # ---------------------------------------------------------
    access_log syslog:server=unix:/dev/log,tag=portal_gateway portal_main;

    # ---------------------------------------------------------
    # Error log → syslog
    # 级别说明：
    # - info  ：调试阶段推荐
    # - warn  ：稳定后可调低
    error_log  syslog:server=unix:/dev/log,tag=portal_gateway info;

    # -----------------------------------------------------
    # DNS resolver（用于 proxy_pass 到域名）
    # -----------------------------------------------------
    resolver 127.0.0.1 valid=30s ipv6=off;

    # -----------------------------------------------------
    # 限速 / 防护（基础）
    # -----------------------------------------------------
    limit_conn_zone $binary_remote_addr zone=portal_conn:10m;
    limit_req_zone  $binary_remote_addr zone=portal_req:10m rate=10r/s;

    # -----------------------------------------------------
    # include Portal Gateway 子配置
    # -----------------------------------------------------
    include /etc/nginx/conf.d/portal/*.conf;
}